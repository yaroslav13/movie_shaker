name: Check-up pull request
on:
    pull_request:
        branches:
        - main
permissions:
  contents: write
  actions:  read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
        - name: 📂 Checkout code
          uses: actions/checkout@v3

        - name: 🚀 Cache pub deps
          uses: actions/cache@v3
          with:
            path: ~/.pub-cache
            key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.yaml') }}
            restore-keys: ${{ runner.os }}-pub-

        - name: ☕️ Setup Java (Temurin 21)
          uses: actions/setup-java@v3
          with:
            distribution: temurin
            java-version: '21'

        - name: 📦 Setup Flutter Version Management CLI
          id: fvm-config-action
          uses: kuhnroyal/flutter-fvm-config-action/setup@v3

        - name: 🦋 Install Flutter SDK
          uses: subosito/flutter-action@v2
          with:
            flutter-version: ${{ steps.fvm-config-action.outputs.FLUTTER_VERSION }}
            channel: ${{ steps.fvm-config-action.outputs.FLUTTER_CHANNEL }}

        - name: 🔧 Activate Melos
          run: fvm dart pub global activate melos

        - name: 📥 Bootstrap monorepo packages
          run: melos bootstrap

        - name: ⚙️ Run code generation
          run: melos run code_gen

        - name: 🔍 Run code analysis
          run: melos analyze

