name: ğŸ” Check-up pull request quality
on:
    pull_request:
        branches:
        - main
permissions:
  contents: write
  actions:  read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
    build:
        runs-on: ubuntu-latest
        environment: GENERAL
        steps:
        - name: ğŸ“‚ Checkout code
          uses: actions/checkout@v3

        - name: â˜•ï¸ Setup Java (Temurin 21)
          uses: actions/setup-java@v3
          with:
            distribution: temurin
            java-version: '21'

        - name: ğŸ¦‹ Install FVM
          run: |
            curl -fsSL https://fvm.app/install.sh | bash
            echo "$HOME/fvm/bin" >> $GITHUB_PATH

        - name: ğŸ“± Install Flutter SDK via FVM
          run: |
            fvm use
            echo "$(pwd)/.fvm/flutter_sdk/bin" >> $GITHUB_PATH
            
        - name: ğŸ“¦ Get Flutter dependencies for example
          run: fvm flutter pub get
          working-directory: packages/ui_components/example

        - name: ğŸ”§ Activate Melos
          run: |
            fvm dart pub global activate melos 7.3.0
            echo "$HOME/.pub-cache/bin" >> $GITHUB_PATH

        - name: âš™ï¸ Install DCM
          uses: CQLabs/setup-dcm@v2
          with:
            github-token: ${{ secrets.GITHUB_TOKEN }}

        - name: ğŸ§¹ Clean Workspace
          run: melos clean

        - name: ğŸ“¦ Melos bootstrap
          run: melos bootstrap

        - name: âš™ï¸ Run code generation
          run: melos run code_gen

        - name: ğŸ” Run code analysis
          env:
            DCM_CI_KEY: ${{ secrets.DCM_CI_KEY }}
            DCM_EMAIL: ${{ secrets.DCM_EMAIL }}
          run: melos analyze

